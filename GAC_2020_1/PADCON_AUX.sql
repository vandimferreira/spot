/* ********************     NOTA GERAL     ******************** */ 
/*SELECT DISTINCT
ROUND((1- @PROC_ATRASADO/ @QT_TOTAL),4)AS VL,
CASE
	WHEN ROUND((1- @PROC_ATRASADO/ @QT_TOTAL),4) BETWEEN 0.9501 AND 1.0000 THEN 10
    WHEN ROUND((1- @PROC_ATRASADO/ @QT_TOTAL),4) BETWEEN 0.9001 AND 0.9500 THEN 9
    WHEN ROUND((1- @PROC_ATRASADO/ @QT_TOTAL),4) BETWEEN 0.8501 AND 0.9000 THEN 8
    WHEN ROUND((1- @PROC_ATRASADO/ @QT_TOTAL),4) BETWEEN 0.8001 AND 0.8500 THEN 7
    WHEN ROUND((1- @PROC_ATRASADO/ @QT_TOTAL),4) BETWEEN 0.7001 AND 0.8000 THEN 6
    WHEN ROUND((1- @PROC_ATRASADO/ @QT_TOTAL),4) BETWEEN 0.6001 AND 0.7000 THEN 5
    WHEN ROUND((1- @PROC_ATRASADO/ @QT_TOTAL),4) BETWEEN 0.3001 AND 0.6000 THEN 4
    WHEN ROUND((1- @PROC_ATRASADO/ @QT_TOTAL),4) BETWEEN 0.0001 AND 0.3000 THEN 3
    WHEN ROUND((1- @PROC_ATRASADO/ @QT_TOTAL),4) BETWEEN -0.5099 AND 0.0000 THEN 2
    WHEN ROUND((1- @PROC_ATRASADO/ @QT_TOTAL),4) BETWEEN -1.0000 AND -0.5100 THEN 1
END AS NOTA
FROM gac.PDCON_AUX
WHERE DIF_DIAS < 0;

SELECT A.PRF_DIR, 
	COUNT(A.PRF_DEMAND) AS TOTAL , 
    IFNULL(B.ATRASADOS,0) AS ATRASADOS,
    ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) AS CALC,
    CASE
	WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.9501 AND 1.0000 THEN 10
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.9001 AND 0.9500 THEN 9
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.8501 AND 0.9000 THEN 8
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.8001 AND 0.8500 THEN 7
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.7001 AND 0.8000 THEN 6
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.6001 AND 0.7000 THEN 5
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.3001 AND 0.6000 THEN 4
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.0001 AND 0.3000 THEN 3
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN -0.5099 AND 0.0000 THEN 2
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN -1.0000 AND -0.5100 THEN 1
END AS NOTA

FROM gac.PDCON_AUX A
LEFT JOIN (SELECT PRF_DIR, SUM(PESO_IND) AS ATRASADOS FROM gac.PDCON_AUX  WHERE DIF_DIAS < 0 GROUP BY PRF_DIR) B
ON(B.PRF_DIR = A.PRF_DIR)

GROUP BY A.PRF_DIR
;
DROP TABLE IF EXISTS gac.PDCON_AUX2 ;

CREATE TABLE gac.PDCON_AUX2 
SELECT * FROM gac.PDCON_AUX WHERE PRF_DEMAND IN(9091, 9093, 7425, 7422, 9099, 7423, 7418, 7420, 7427);

SELECT A.PRF_CESUP_REDE, 
	COUNT(A.PRF_DEMAND) AS TOTAL , 
    IFNULL(B.ATRASADOS,0) AS ATRASADOS,
    ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) AS CALC,
    CASE
	WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.9501 AND 1.0000 THEN 10
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.9001 AND 0.9500 THEN 9
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.8501 AND 0.9000 THEN 8
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.8001 AND 0.8500 THEN 7
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.7001 AND 0.8000 THEN 6
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.6001 AND 0.7000 THEN 5
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.3001 AND 0.6000 THEN 4
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.0001 AND 0.3000 THEN 3
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN -0.5099 AND 0.0000 THEN 2
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN -1.0000 AND -0.5100 THEN 1
END AS NOTA

FROM gac.PDCON_AUX2 A
LEFT JOIN (SELECT PRF_CESUP_REDE, SUM(PESO_IND) AS ATRASADOS FROM gac.PDCON_AUX2  WHERE DIF_DIAS < 0 GROUP BY PRF_CESUP_REDE) B
ON(B.PRF_CESUP_REDE = A.PRF_CESUP_REDE)

GROUP BY A.PRF_CESUP_REDE
;

SELECT -- A.PRF_DIR, 
	A.PRF_DEMAND,
	COUNT(A.PRF_DEMAND) AS TOTAL , 
    IFNULL(B.ATRASADOS,0) AS ATRASADOS,
    ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) AS CALC,
    CASE
	WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.9501 AND 1.0000 THEN 10
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.9001 AND 0.9500 THEN 9
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.8501 AND 0.9000 THEN 8
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.8001 AND 0.8500 THEN 7
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.7001 AND 0.8000 THEN 6
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.6001 AND 0.7000 THEN 5
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.3001 AND 0.6000 THEN 4
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.0001 AND 0.3000 THEN 3
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN -0.5099 AND 0.0000 THEN 2
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN -1.0000 AND -0.5100 THEN 1
END AS NOTA

FROM gac.PDCON_AUX A
LEFT JOIN (SELECT PRF_DIR, PRF_DEMAND, SUM(PESO_IND) AS ATRASADOS FROM gac.PDCON_AUX  WHERE DIF_DIAS < 0 GROUP BY PRF_DEMAND) B
ON(B.PRF_DEMAND = A.PRF_DEMAND)

GROUP BY A.PRF_DEMAND
;*/





SET @QT_TOTAL:= (SELECT COUNT(*) FROM gac.PDCON_AUX);
-- SELECT @QT_TOTAL;

SET @PROC_ATRASADO:= (SELECT SUM(PESO_IND) FROM gac.PDCON_AUX WHERE DIF_DIAS < 0);
-- SELECT @PROC_ATRASADO;

SELECT 
	1 AS cd_bloc, 
    177 AS cd_in, 
	A.PRF_DEMAND as cd_prf_depe,
    @ANO_REF as ano_ref,  
	@MES_REF as mes_ref, 
	DATEDIFF(CURDATE(), 19600101) as dt_prct,
	-- COUNT(A.PRF_DEMAND) AS TOTAL , 
    -- IFNULL(B.ATRASADOS,0) AS ATRASADOS,
    ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) AS pc_rstd,
    CASE
	WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.9501 AND 1.0000 THEN 10.0000
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.9001 AND 0.9500 THEN 9.0000
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.8501 AND 0.9000 THEN 8.0000
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.8001 AND 0.8500 THEN 7.0000
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.7001 AND 0.8000 THEN 6.0000
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.6001 AND 0.7000 THEN 5.0000
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.3001 AND 0.6000 THEN 4.0000
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN 0.0001 AND 0.3000 THEN 3.0000
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN -0.5099 AND 0.0000 THEN 2.0000
    WHEN ROUND(1 - (IFNULL(B.ATRASADOS, 0) / COUNT(A.PRF_DEMAND)),4) BETWEEN -1.0000 AND -0.5100 THEN 1.0000
END AS cd_rstd,
QUOTE(concat('PERÍODO DE APURAÇÃO: ', @INI_CMP, ' A ', @FIM_CMP)) as tx_jst_rstd

FROM gac.PDCON_AUX A
LEFT JOIN (SELECT PRF_DIR, PRF_DEMAND, SUM(PESO_IND) AS ATRASADOS FROM gac.PDCON_AUX  WHERE DIF_DIAS < 0 GROUP BY PRF_DEMAND) B
ON(B.PRF_DEMAND = A.PRF_DEMAND)

WHERE A.PRF_DIR <> A.PRF_DEMAND

GROUP BY A.PRF_DEMAND
;