SET @INI_CMP := 20200101;
SET @FIM_CMP := 20200131;
SET @AA_MM_INI := EXTRACT(YEAR_MONTH FROM @INI_CMP);
SET @AA_MM_FIM := EXTRACT(YEAR_MONTH FROM @FIM_CMP);
SET @ANO_REF:= YEAR(@INI_CMP);
SET @MES_REF:= MONTH(@FIM_CMP);


SET @QT_TOTAL := (
SELECT COUNT(*)
FROM fluxoTrabalho.evt A

LEFT JOIN fluxoTrabalho.ctu_etp_evt B
ON(B.AA_EVT = A.AA_EVT AND B.NR_EVT = A.NR_EVT AND B.CD_SUB_PROJ = A.CD_SUB_PROJ AND B.CD_ETP IN(122, 480, 487, 519, 566, 674, 675, 676, 677, 678, 683, 684)) -- (122, 480, 487)), 

LEFT JOIN fluxoTrabalho.etp_tip_evt C 
ON(C.CD_SUB_PROJ = A.CD_SUB_PROJ AND C.CD_ETP = B.CD_ETP)

WHERE 
B.DT_FIM_ETP BETWEEN @INI_CMP AND @FIM_CMP -- DATA FIM DA ETAPA 122, 480, 487
AND A.CD_FASE_EVT NOT IN (5)   
AND A.CD_SUB_PROJ IN (62, 60, 61, 115, 169, 68, 69, 70, 71, 72, 73,  208, 218, 215, 219, 220, 221, 222, 223, 224, 212, 213, 214, 225, 210, 211, 238, 363)
AND A.CD_PRF_EXEC <> 8558
AND B.IN_ETP_ATV = 1)
;

SET @QT_REALZ  := (
SELECT COUNT(*) FROM (
SELECT
A.AA_EVT,
A.NR_EVT,
A.TX_EVT,
A.DSC_EVT,
A.CD_FASE_EVT,
A.CD_PRF_EXEC,
A.CD_PROJ,
A.CD_SUB_PROJ,
A.DT_INC_EVT,
A.DT_FIM_EVT,
A.CD_PRIO_EVT,
A.CD_EPRD,
A.CD_PRF_DEPE_BNFD,
A.CD_ORD_DEPE_SBDD_BNFD,
A.CD_UOR_BNFD,
A.TS_CRIC_EVT, 
B.CD_ETP, 
B.DT_FIM_ETP,
B.IN_ETP_ATV , 
(DATEDIFF(IFNULL(B.DT_FIM_ETP, CURDATE()), B.DT_INC_ETP)) AS DT_REF,
C.QT_DD_PZ

FROM fluxoTrabalho.evt A

LEFT JOIN fluxoTrabalho.ctu_etp_evt B
ON(B.AA_EVT = A.AA_EVT AND B.NR_EVT = A.NR_EVT AND B.CD_SUB_PROJ = A.CD_SUB_PROJ AND B.CD_ETP IN(122, 480, 487, 519, 566, 674, 675, 676, 677, 678, 683, 684)) -- (122, 480, 487))

LEFT JOIN fluxoTrabalho.etp_tip_evt C 
ON(C.CD_SUB_PROJ = A.CD_SUB_PROJ AND C.CD_ETP = B.CD_ETP)) Z

WHERE 
Z.DT_FIM_ETP BETWEEN @INI_CMP AND @FIM_CMP
AND Z.CD_FASE_EVT NOT IN (5)   
AND Z.CD_SUB_PROJ IN (62, 60, 61, 115, 169, 68, 69, 70, 71, 72, 73,  208, 218, 215, 218, 219, 220, 221, 222, 223, 224, 212, 213, 214, 225, 210, 211, 238, 363)
AND Z.CD_PRF_EXEC <> 8558
AND Z.IN_ETP_ATV = 1
AND Z.DT_REF <= Z.QT_DD_PZ
);

SET @PC_REALZ := (@QT_REALZ/ @QT_TOTAL);



TRUNCATE TABLE gac.ANALISE_DEMANDA_GAC1;
INSERT INTO  gac.ANALISE_DEMANDA_GAC1
SELECT DISTINCT
1 AS cd_bloc, 
175 as cd_in, 
8558 as cd_prf_depe, 
@ANO_REF as ano_ref,  
@MES_REF as mes_ref, 
DATEDIFF(CURDATE(), 19600101) as dt_prct,
ROUND(@PC_REALZ , 4) as pc_rstd,
CASE 
	WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.0000 AND 0.7099 THEN 1.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.7100 AND 0.7699 THEN 2.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.7700 AND 0.7999 THEN 3.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.8000 AND 0.8299 THEN 4.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.8300 AND 0.8599 THEN 5.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.8600 AND 0.8999 THEN 6.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.9000 AND 0.9299 THEN 7.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.9300 AND 0.9599 THEN 8.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.9600 AND 0.9899 THEN 9.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.9900 AND 1.0000 THEN 10.0000
END AS cd_rstd,
concat('PERÍODO DE APURAÇÃO: ', @INI_CMP, ' A ', @FIM_CMP) as tx_jst_rstd

UNION 

SELECT DISTINCT
1 AS cd_bloc, 
175 as cd_in, 
7421 as cd_prf_depe, 
@ANO_REF as ano_ref,  
@MES_REF as mes_ref, 
DATEDIFF(CURDATE(), 19600101) as dt_prct,
ROUND( @PC_REALZ , 4) as pc_rstd,
CASE 
	WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.0000 AND 0.7099 THEN 1.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.7100 AND 0.7699 THEN 2.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.7700 AND 0.7999 THEN 3.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.8000 AND 0.8299 THEN 4.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.8300 AND 0.8599 THEN 5.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.8600 AND 0.8999 THEN 6.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.9000 AND 0.9299 THEN 7.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.9300 AND 0.9599 THEN 8.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.9600 AND 0.9899 THEN 9.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.9900 AND 1.0000 THEN 10.0000
END AS cd_rstd,
concat('PERÍODO DE APURAÇÃO: ', @INI_CMP, ' A ', @FIM_CMP) as tx_jst_rstd

UNION 

SELECT DISTINCT
1 AS cd_bloc, 
175 as cd_in, 
10000 as cd_prf_depe, 
@ANO_REF as ano_ref,  
@MES_REF as mes_ref, 
DATEDIFF(CURDATE(), 19600101) as dt_prct,
ROUND( @PC_REALZ , 4) as pc_rstd,
CASE 
	WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.0000 AND 0.7099 THEN 1.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.7100 AND 0.7699 THEN 2.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.7700 AND 0.7999 THEN 3.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.8000 AND 0.8299 THEN 4.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.8300 AND 0.8599 THEN 5.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.8600 AND 0.8999 THEN 6.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.9000 AND 0.9299 THEN 7.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.9300 AND 0.9599 THEN 8.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.9600 AND 0.9899 THEN 9.0000
    WHEN ROUND(@PC_REALZ, 4) BETWEEN  0.9900 AND 1.0000 THEN 10.0000
END AS cd_rstd,
concat('PERÍODO DE APURAÇÃO: ', @INI_CMP, ' A ', @FIM_CMP) as tx_jst_rstd
;



/** ***********************GAC02************************** */
TRUNCATE TABLE gac.ANALISE_DEMANDA_GAC2;
INSERT INTO gac.ANALISE_DEMANDA_GAC2
SELECT DISTINCT
120 as cd_vrv,  -- QT ETAPAS CONCLUIDAS NO PRAZO
8558 as cd_prf_depe, 
@ANO_REF as ano_ref,  
@MES_REF as mes_ref,  
@QT_REALZ as vl_vrv, 
175 as cd_in

UNION 

SELECT DISTINCT
121 as cd_crv, -- QT TOTAL ETAPAS CONCLUIDAS
8558 as cd_prf_depe, 
@ANO_REF as ano_ref,  
@MES_REF as mes_ref,  
@QT_TOTAL as vl_vrv, 
175 as cd_in

UNION 

SELECT DISTINCT
120 as cd_vrv, -- QT ETAPAS CONCLUIDAS NO PRAZO
7421 as cd_prf_depe, 
@ANO_REF as ano_ref,  
@MES_REF as mes_ref,  
@QT_REALZ as vl_vrv, 
175 as cd_in

UNION 

SELECT DISTINCT
121 as cd_crv,   -- QT TOTAL ETAPAS CONCLUIDAS
7421 as cd_prf_depe, 
@ANO_REF as ano_ref,  
@MES_REF as mes_ref,  
@QT_TOTAL as vl_vrv, 
175 as cd_in

UNION 

SELECT DISTINCT
120 as cd_vrv,  -- QT ETAPAS CONCLUIDAS NO PRAZO
10000 as cd_prf_depe, 
@ANO_REF as ano_ref,  
@MES_REF as mes_ref,  
@QT_REALZ as vl_vrv, 
175 as cd_in

UNION 

SELECT DISTINCT
121 as cd_crv, -- QT TOTAL ETAPAS CONCLUIDAS
10000 as cd_prf_depe, 
@ANO_REF as ano_ref,  
@MES_REF as mes_ref,  
@QT_TOTAL as vl_vrv, 
175 as cd_in

;



/** ***********************GAC03************************** */
TRUNCATE TABLE  gac.ANALISE_DEMANDA_GAC3;
INSERT INTO gac.ANALISE_DEMANDA_GAC3

SELECT DISTINCT
23 as cd_evt, 
175 as cd_in, 
2 as qlc_evt, 
7421 as cd_prf_depe,
CONCAT(Z.AA_EVT, ' ', Z.NR_EVT) as nr_doc, 
@ANO_REF as ano_ref,  
@MES_REF as mes_ref, 
DATEDIFF(CURDATE() , 19600101) as dt_prct

FROM (
SELECT
A.AA_EVT,
A.NR_EVT,
A.TX_EVT,
A.DSC_EVT,
A.CD_FASE_EVT,
A.CD_PRF_EXEC,
A.CD_PROJ,
A.CD_SUB_PROJ,
A.DT_INC_EVT,
A.DT_FIM_EVT,
A.CD_PRIO_EVT,
A.CD_EPRD,
A.CD_PRF_DEPE_BNFD,
A.CD_ORD_DEPE_SBDD_BNFD,
A.CD_UOR_BNFD,
A.TS_CRIC_EVT, 
B.CD_ETP, 
B.DT_FIM_ETP,
B.IN_ETP_ATV , 
(DATEDIFF(IFNULL(B.DT_FIM_ETP, CURDATE()), B.DT_INC_ETP)) AS DT_REF,
C.QT_DD_PZ

FROM fluxoTrabalho.evt A

LEFT JOIN fluxoTrabalho.ctu_etp_evt B
ON(B.AA_EVT = A.AA_EVT AND B.NR_EVT = A.NR_EVT AND B.CD_SUB_PROJ = A.CD_SUB_PROJ AND B.CD_ETP IN(122, 480, 487, 519, 566, 674, 675, 676, 677, 678, 683, 684)) -- (122, 480, 487))

LEFT JOIN fluxoTrabalho.etp_tip_evt C 
ON(C.CD_SUB_PROJ = A.CD_SUB_PROJ AND C.CD_ETP = B.CD_ETP)) Z

WHERE 
Z.DT_FIM_ETP BETWEEN  @INI_CMP AND @FIM_CMP
AND Z.CD_FASE_EVT NOT IN (5)   
AND Z.CD_SUB_PROJ IN (62, 60, 61, 115, 169, 68, 69, 70, 71, 72, 73,  208, 218, 215, 218, 219, 220, 221, 222, 223, 224, 212, 213, 214, 225, 210, 211, 238, 363)
AND Z.CD_PRF_EXEC <> 8558
AND Z.IN_ETP_ATV = 1
AND Z.DT_REF > Z.QT_DD_PZ;

/*DROP TABLE gac.ANALISE_DEMANDA;
CREATE TABLE gac.ANALISE_DEMANDA*/

DELETE FROM gac.ANALISE_DEMANDA;
INSERT INTO gac.ANALISE_DEMANDA
SELECT 
A.NR_EVT, 
A.AA_EVT, 
A.TX_EVT, 
A.DSC_EVT, 
A.CD_FASE_EVT, 
A.CD_PRF_EXEC, 
A.CD_PROJ,
D.NM_PROJ, 
A.CD_SUB_PROJ, 
E.NM_SUB_PROJ,
A.DT_PRV_INC_EVT,
A.DT_PRV_FIM_EVT, 
A.DT_INC_EVT, 
A.DT_FIM_EVT, 
A.CD_PRF_DEPE_BNFD, 
A.CD_ORD_DEPE_SBDD_BNFD, 
A.CD_UOR_BNFD, 
A.CD_USU_CRIC_EVT, 
A.TS_CRIC_EVT, 
A.TS_ALT_EVT, 
B.CD_ETP, 
B.IN_ETP_ATV, 
B.DT_INC_ETP, 
B.DT_FIM_ETP, 
DATEDIFF(IFNULL(B.DT_FIM_ETP, CURDATE()), B.DT_INC_ETP) AS DIAS_DIF,
C.QT_DD_PZ



FROM fluxoTrabalho.evt A

LEFT JOIN fluxoTrabalho.ctu_etp_evt B
ON(B.AA_EVT = A.AA_EVT AND B.NR_EVT = A.NR_EVT AND B.CD_SUB_PROJ = A.CD_SUB_PROJ AND B.CD_ETP IN(122, 480, 487, 519, 566, 674, 675, 676, 677, 678, 683, 684)) -- (122, 480, 487))

LEFT JOIN fluxoTrabalho.etp_tip_evt C 
ON(C.CD_SUB_PROJ = A.CD_SUB_PROJ AND C.CD_ETP = B.CD_ETP)

LEFT JOIN fluxoTrabalho.proj D 
ON(D.CD_PROJ = A.CD_PROJ)

LEFT JOIN fluxoTrabalho.sub_proj E 
ON(E.CD_SUB_PROJ = A.CD_SUB_PROJ)


WHERE 
B.DT_FIM_ETP BETWEEN @INI_CMP AND IFNULL(@FIM_CMP, DATE(TS_ALT_EVT))
AND A.CD_FASE_EVT NOT IN (5)   
AND A.CD_SUB_PROJ IN (62, 60, 61, 115, 169, 68, 69, 70, 71, 72, 73,  208, 218, 215, 219, 220, 221, 222, 223, 224, 212, 213, 214, 225, 210, 211, 238, 363)
AND A.CD_PRF_EXEC <> 8558
AND B.IN_ETP_ATV = 1
;


-- SELECTS PARA FORMATAR DE ACORDO COM O PADRÃO SAS.

SELECT
	'VALUES(',
	cd_bloc,
	',',
	cd_in,
	',',
	cd_prf_depe,
	',',
	ano_ref,
	',',
	mes_ref,
	',',
	dt_prct,
	',',
	pc_rstd,
	',',
	cd_rstd,
	',',
	QUOTE(tx_jst_rstd),
	')'
FROM 
	gac.ANALISE_DEMANDA_GAC1
;


SELECT
	'VALUES(',
	cd_vrv,
	',',
	cd_prf_depe,
	',',
	ano_ref,
	',',
	mes_ref,
	',',
	vl_vrv,
	',',
	cd_in,
	')'
FROM 
	gac.ANALISE_DEMANDA_GAC2
;


SELECT
	'VALUES(',
	cd_evt,
	',',
	cd_in,
	',',
	qlc_evt,
	',',
	cd_prf_depe,
	',',
	QUOTE(nr_doc),
	',',
	ano_ref,
	',',
	mes_ref,
	',',
	dt_prct,
	')'
FROM 
	gac.ANALISE_DEMANDA_GAC3
;




